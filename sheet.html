<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Daggerheart Sheet</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .container {
      max-width: 900px;
      margin: 1rem auto;
      padding: 0 1rem;
    }

    .sheet-wrapper {
      position: relative;
      width: 850px;   /* match your PNG width */
      height: 1100px; /* match your PNG height */
      background-image: url("assets/daggerheart-core.png");
      background-size: cover;
      background-repeat: no-repeat;
      border: 1px solid #333;
    }

    .status {
      font-size: 0.8rem;
      color: #aaa;
    }

    /* === Base field wrapper === */
    .field {
      position: absolute;
      font-size: 12px;
    }

    /* === Inputs/areas on the sheet (NOT the homepage) === */
    .sheet-wrapper input[type="text"],
    .sheet-wrapper textarea {
      background: transparent;
      border: none;
      color: #111;
      padding: 0 2px;
      font-size: 12px;
      outline: none;
    }

    .sheet-wrapper input.text-line {
      width: 150px;
      border-bottom: 1px solid rgba(255,255,255,0.4);
    }

    .sheet-wrapper input.number-slot {
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      width: 42px;
      min-width: 32px;
      border-bottom: 1px solid rgba(255,255,255,0.4);
    }

    .center-anchor {
      transform: translate(-50%, -50%);
    }

    .sheet-wrapper input[type="checkbox"] {
      width: 14px;
      height: 14px;
    }

    /* === Text Box (used for everything that’s not a single line) === */
    .text-box {
      width: 260px;
      height: 90px;
      resize: none;
      border: 1px solid rgba(255,255,255,0.35);
      border-radius: 4px;
      padding: 3px 4px;
      line-height: 18px; /* roomier line spacing */
    }

    /* === Debug helper (optional): add "debug" class on any field === */
    .field.debug input[type="text"],
    .field.debug input[type="checkbox"],
    .field.debug textarea {
      outline: 1px solid rgba(0, 255, 0, 0.7);
      background: rgba(0, 0, 0, 0.25);
    }

    /* === Tracks (checkbox series) === */
    .track-container {
      position: absolute;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
    }

    .track-container .field {
      position: static;
    }

    .track-disabled {
      opacity: 0.35;
    }

    /* Optional: park new fields off-canvas until you position them */
    .parked {
      top: -100px !important;
      left: -100px !important;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>Daggerheart Character Sheet</h1>
    <p class="status" id="meta"></p>
    <p class="status" id="connection-status"></p>

    <div class="sheet-wrapper">

      <!-- =========================================================
           TRACK MAX FIELDS (move these onto the sheet)
           ========================================================= -->
      <div class="field center-anchor" data-key="armor_max" style="top: 143px; left: 146px;">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[0-9]{0,2}" maxlength="2" placeholder="12" title="Armor Max">
      </div>

      <div class="field parked" data-key="hp_max">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[0-9]{0,2}" maxlength="2" placeholder="12" title="HP Max">
      </div>

      <div class="field parked" data-key="stress_max">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[0-9]{0,2}" maxlength="2" placeholder="12" title="Stress Max">
      </div>

      <div class="field parked" data-key="hope_max">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[0-9]{0,2}" maxlength="2" placeholder="10" title="Hope Max">
      </div>

      <div class="field parked" data-key="gold_hand_max">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[0-9]{0,2}" maxlength="2" placeholder="9" title="Handfuls Max">
      </div>

      <div class="field parked" data-key="gold_bag_max">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[0-9]{0,2}" maxlength="2" placeholder="9" title="Bags Max">
      </div>

      <div class="field parked" data-key="proficiency_max">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[0-9]{0,2}" maxlength="2" placeholder="6" title="Proficiency Max">
      </div>


      <!-- =========================================================
           TOP INFO (Text Lines + Number Slots)
           ========================================================= -->
      <div class="field parked" data-key="name">
        <input type="text" class="text-line" placeholder="Name" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="pronouns">
        <input type="text" class="text-line" placeholder="Pronouns" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="heritage">
        <input type="text" class="text-line" placeholder="Heritage" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="class_subclass">
        <input type="text" class="text-line" placeholder="Class & Subclass" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="level">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Level">
      </div>

      <div class="field parked" data-key="evasion">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Evasion">
      </div>


      <!-- =========================================================
           ARMOR (Number Slot + Checkbox Series rendered by JS track)
           ========================================================= -->
      <div class="field parked" data-key="armor_value">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Armor Value">
      </div>


      <!-- =========================================================
           STATS (each has Value + Proficiency Checkbox)
           ========================================================= -->
      <div class="field parked" data-key="agility_value">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Agility">
      </div>
      <div class="field parked" data-key="agility_checkbox">
        <input type="checkbox" title="Agility proficient">
      </div>

      <div class="field parked" data-key="strength_value">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Strength">
      </div>
      <div class="field parked" data-key="strength_checkbox">
        <input type="checkbox" title="Strength proficient">
      </div>

      <div class="field parked" data-key="finesse_value">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Finesse">
      </div>
      <div class="field parked" data-key="finesse_checkbox">
        <input type="checkbox" title="Finesse proficient">
      </div>

      <div class="field parked" data-key="instinct_value">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Instinct">
      </div>
      <div class="field parked" data-key="instinct_checkbox">
        <input type="checkbox" title="Instinct proficient">
      </div>

      <div class="field parked" data-key="presence_value">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Presence">
      </div>
      <div class="field parked" data-key="presence_checkbox">
        <input type="checkbox" title="Presence proficient">
      </div>

      <div class="field parked" data-key="knowledge_value">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Knowledge">
      </div>
      <div class="field parked" data-key="knowledge_checkbox">
        <input type="checkbox" title="Knowledge proficient">
      </div>


      <!-- =========================================================
           THRESHOLDS
           ========================================================= -->
      <div class="field parked" data-key="threshold_minor">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Minor Threshold">
      </div>

      <div class="field parked" data-key="threshold_major">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Major Threshold">
      </div>

      <div class="field parked" data-key="threshold_severe">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Severe Threshold">
      </div>


      <!-- =========================================================
           HOPE FEATURE (Text Box)
           ========================================================= -->
      <div class="field parked" data-key="hope_feature">
        <textarea class="text-box" placeholder=""></textarea>
      </div>


      <!-- =========================================================
           EXPERIENCE 1..5 (Text Line + Bonus Number Slot)
           ========================================================= -->
      <div class="field parked" data-key="experience_1_text">
        <input type="text" class="text-line" placeholder="Experience 1" autocomplete="off" spellcheck="false">
      </div>
      <div class="field parked" data-key="experience_1_bonus">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Exp 1 Bonus">
      </div>

      <div class="field parked" data-key="experience_2_text">
        <input type="text" class="text-line" placeholder="Experience 2" autocomplete="off" spellcheck="false">
      </div>
      <div class="field parked" data-key="experience_2_bonus">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Exp 2 Bonus">
      </div>

      <div class="field parked" data-key="experience_3_text">
        <input type="text" class="text-line" placeholder="Experience 3" autocomplete="off" spellcheck="false">
      </div>
      <div class="field parked" data-key="experience_3_bonus">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Exp 3 Bonus">
      </div>

      <div class="field parked" data-key="experience_4_text">
        <input type="text" class="text-line" placeholder="Experience 4" autocomplete="off" spellcheck="false">
      </div>
      <div class="field parked" data-key="experience_4_bonus">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Exp 4 Bonus">
      </div>

      <div class="field parked" data-key="experience_5_text">
        <input type="text" class="text-line" placeholder="Experience 5" autocomplete="off" spellcheck="false">
      </div>
      <div class="field parked" data-key="experience_5_bonus">
        <input type="text" class="number-slot" inputmode="numeric" pattern="[+-]?[0-9]{0,3}" maxlength="4" placeholder="0" title="Exp 5 Bonus">
      </div>


      <!-- =========================================================
           GOLD (Chest is a single checkbox; Handfuls/Bags are tracks via JS)
           ========================================================= -->
      <div class="field parked" data-key="gold_chest">
        <input type="checkbox" title="Gold Chest">
      </div>


      <!-- =========================================================
           CLASS FEATURE (Text Box)
           ========================================================= -->
      <div class="field" data-key="class_feature" style="top: 785px; left: 6px;">
        <textarea class="text-box" placeholder=""></textarea>
      </div>


      <!-- =========================================================
           WEAPON (Primary)
           ========================================================= -->
      <div class="field parked" data-key="weapon_name">
        <input type="text" class="text-line" placeholder="Weapon Name" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="weapon_trait">
        <input type="text" class="text-line" placeholder="Weapon Trait" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="weapon_range">
        <input type="text" class="text-line" placeholder="Weapon Range" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="weapon_damage_dice_type">
        <input type="text" class="text-line" placeholder="Damage Dice & Type" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="weapon_feature">
        <textarea class="text-box" placeholder=""></textarea>
      </div>


      <!-- =========================================================
           SECONDARY WEAPON
           ========================================================= -->
      <div class="field parked" data-key="secondary_weapon_name">
        <input type="text" class="text-line" placeholder="Secondary Weapon Name" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="secondary_weapon_trait">
        <input type="text" class="text-line" placeholder="Secondary Weapon Trait" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="secondary_weapon_range">
        <input type="text" class="text-line" placeholder="Secondary Weapon Range" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="secondary_weapon_damage_dice_type">
        <input type="text" class="text-line" placeholder="Damage Dice & Type" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="secondary_weapon_feature">
        <textarea class="text-box" placeholder=""></textarea>
      </div>


      <!-- =========================================================
           ARMOR DETAILS
           ========================================================= -->
      <div class="field parked" data-key="armor_name">
        <input type="text" class="text-line" placeholder="Armor Name" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="armor_base_thresholds">
        <input type="text" class="text-line" placeholder="Base Thresholds" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="armor_base_score">
        <input type="text" class="text-line" placeholder="Base Score" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="armor_feature">
        <textarea class="text-box" placeholder=""></textarea>
      </div>


      <!-- =========================================================
           INVENTORY (Text Box)
           ========================================================= -->
      <div class="field" data-key="inventory" style="top: 682px; left: 406px;">
        <textarea class="text-box" placeholder=""></textarea>
      </div>


      <!-- =========================================================
           INVENTORY SLOT 1 WEAPON (Primary fields)
           ========================================================= -->
      <div class="field parked" data-key="inventory_slot1_weapon_name">
        <input type="text" class="text-line" placeholder="Inv Slot 1 Weapon Name" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="inventory_slot1_weapon_trait">
        <input type="text" class="text-line" placeholder="Inv Slot 1 Trait" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="inventory_slot1_weapon_range">
        <input type="text" class="text-line" placeholder="Inv Slot 1 Range" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="inventory_slot1_weapon_damage_dice_type">
        <input type="text" class="text-line" placeholder="Inv Slot 1 Damage" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="inventory_slot1_weapon_feature">
        <textarea class="text-box" placeholder=""></textarea>
      </div>

      <div class="field parked" data-key="inventory_slot1_weapon_primary_toggle">
        <input type="checkbox" title="Slot 1 Primary Toggle">
      </div>

      <div class="field parked" data-key="inventory_slot1_weapon_secondary_toggle">
        <input type="checkbox" title="Slot 1 Secondary Toggle">
      </div>


      <!-- =========================================================
           INVENTORY SLOT 2 WEAPON (with Left/Right hand + toggles)
           ========================================================= -->
      <div class="field parked" data-key="inventory_slot2_weapon_name">
        <input type="text" class="text-line" placeholder="Inv Slot 2 Weapon Name" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="inventory_slot2_weapon_trait">
        <input type="text" class="text-line" placeholder="Inv Slot 2 Trait" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="inventory_slot2_weapon_range">
        <input type="text" class="text-line" placeholder="Inv Slot 2 Range" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="inventory_slot2_weapon_damage_dice_type">
        <input type="text" class="text-line" placeholder="Inv Slot 2 Damage" autocomplete="off" spellcheck="false">
      </div>

      <div class="field parked" data-key="inventory_slot2_weapon_feature">
        <textarea class="text-box" placeholder=""></textarea>
      </div>

      <div class="field parked" data-key="inventory_slot2_weapon_left_hand">
        <input type="checkbox" title="Slot 2 Left Hand">
      </div>

      <div class="field parked" data-key="inventory_slot2_weapon_right_hand">
        <input type="checkbox" title="Slot 2 Right Hand">
      </div>

      <div class="field parked" data-key="inventory_slot2_weapon_primary_toggle">
        <input type="checkbox" title="Slot 2 Primary Toggle">
      </div>

      <div class="field parked" data-key="inventory_slot2_weapon_secondary_toggle">
        <input type="checkbox" title="Slot 2 Secondary Toggle">
      </div>


      <!-- =========================================================
           MISC / CONDITIONS (example from your early test)
           ========================================================= -->
      <div class="field parked" data-key="condition_wounded">
        <input type="checkbox" title="Wounded">
      </div>

    </div>
  </main>

  <!-- === Coordinate helper: click to log top/left relative to sheet === -->
  <script>
    (function () {
      const wrapper = document.querySelector(".sheet-wrapper");
      if (!wrapper) return;

      wrapper.addEventListener("click", (e) => {
        const rect = wrapper.getBoundingClientRect();
        const top = Math.round(e.clientY - rect.top);
        const left = Math.round(e.clientX - rect.left);
        console.log(
          `[coord] top: ${top}px; left: ${left}px;  --> style="top: ${top}px; left: ${left}px;"`
        );
      });
    })();
  </script>

  <!-- === Track generators === -->
  <script>
    (function () {
      const wrapper = document.querySelector(".sheet-wrapper");
      if (!wrapper) return;

      function createLinearTrack(baseKey, count, top, left, gapX = 18) {
        const container = document.createElement("div");
        container.className = "track-container";
        container.style.top = top + "px";
        container.style.left = left + "px";

        for (let i = 0; i < count; i++) {
          const fieldWrapper = document.createElement("div");
          fieldWrapper.className = "field";
          fieldWrapper.dataset.key = `${baseKey}_${i}`;

          const input = document.createElement("input");
          input.type = "checkbox";

          fieldWrapper.style.marginRight = (i === count - 1 ? 0 : gapX) + "px";

          fieldWrapper.appendChild(input);
          container.appendChild(fieldWrapper);
        }

        wrapper.appendChild(container);
      }

      function createGridTrack(baseKey, rows, cols, top, left, gapX = 18, gapY = 10) {
        const container = document.createElement("div");
        container.className = "track-container";
        container.style.top = top + "px";
        container.style.left = left + "px";
        container.style.display = "grid";
        container.style.gridTemplateColumns = `repeat(${cols}, auto)`;
        container.style.columnGap = gapX + "px";
        container.style.rowGap = gapY + "px";

        const count = rows * cols;
        for (let i = 0; i < count; i++) {
          const fieldWrapper = document.createElement("div");
          fieldWrapper.className = "field";
          fieldWrapper.dataset.key = `${baseKey}_${i}`;

          const input = document.createElement("input");
          input.type = "checkbox";

          fieldWrapper.appendChild(input);
          container.appendChild(fieldWrapper);
        }

        wrapper.appendChild(container);
      }

      // ===== Tracks: set coords after you click-log positions =====
      // NOTE: these should NOT be "parked" — move them by editing these coords.

      // Armor: 12 (4 rows of 3)
      createGridTrack("armor", 4, 3, 107, 182, 0, 0);

      // HP: 12
      createLinearTrack("hp", 12, 315, 50, 1);

      // Stress: 12 (tighter)
      createLinearTrack("stress", 12, 345, 84, -2);

      // Hope: 10 (adjust if sheet uses different)
      createLinearTrack("hope", 6, 420, 55, 24);

      // Gold: 9 and 9
      createLinearTrack("gold_hand", 9, 707, 18, -8);
      createLinearTrack("gold_bag", 9, 707, 180, -9);

      // Proficiency: 6
      createLinearTrack("proficiency", 6, 235, 606, -10);
    })();
  </script>

  <script>
    (function () {
      const wrapper = document.querySelector(".sheet-wrapper");
      if (!wrapper) return;

      // Toggle layout mode with ?layout=1
      const params = new URLSearchParams(window.location.search);
      const layoutMode = params.get("layout") === "1";

      // Simple floating toolbar
      const bar = document.createElement("div");
      bar.style.position = "fixed";
      bar.style.top = "10px";
      bar.style.right = "10px";
      bar.style.zIndex = "9999";
      bar.style.padding = "10px";
      bar.style.border = "1px solid rgba(255,255,255,0.2)";
      bar.style.borderRadius = "10px";
      bar.style.background = "rgba(0,0,0,0.7)";
      bar.style.color = "#fff";
      bar.style.fontSize = "12px";
      bar.style.display = layoutMode ? "block" : "none";

      bar.innerHTML = `
        <div style="font-weight:700;margin-bottom:6px;">Layout Mode</div>
        <div style="margin-bottom:6px;">Drag fields. Hold <b>Shift</b> = snap 10px.</div>
        <button id="save-layout" style="margin-right:6px;">Save Layout</button>
        <button id="reload-layout" style="margin-right:6px;">Reload</button>
        <button id="toggle-outlines">Outlines</button>
        <div id="pos-readout" style="margin-top:6px;opacity:0.85;"></div>
      `;
      document.body.appendChild(bar);

      if (!layoutMode) return;

      const btnSave = document.getElementById("save-layout");
      const btnReload = document.getElementById("reload-layout");
      const btnOutlines = document.getElementById("toggle-outlines");
      const readout = document.getElementById("pos-readout");

      btnSave.addEventListener("click", async () => {
        try {
          await window.__layout.saveLayout();
          readout.textContent = "Saved layout ✔";
        } catch (e) {
          console.error(e);
          readout.textContent = "Save failed ❌ (see console)";
        }
      });

      btnReload.addEventListener("click", async () => {
        try {
          await window.__layout.reloadLayout();
          readout.textContent = "Reloaded layout ✔";
        } catch (e) {
          console.error(e);
          readout.textContent = "Reload failed ❌";
        }
      });

      let outlines = false;
      btnOutlines.addEventListener("click", () => {
        outlines = !outlines;
        document.querySelectorAll(".field").forEach(f => {
          f.style.outline = outlines ? "1px dashed rgba(0,255,0,0.8)" : "";
        });
      });

      // Click-to-log coordinates still available
      wrapper.addEventListener("click", (e) => {
        const rect = wrapper.getBoundingClientRect();
        const top = Math.round(e.clientY - rect.top);
        const left = Math.round(e.clientX - rect.left);
        console.log(`[coord] top:${top}px left:${left}px`);
      });

      // Drag and drop fields
      let dragging = null;
      let startMouse = { x: 0, y: 0 };
      let startPos = { top: 0, left: 0 };

      function getFieldTarget(el) {
        return el.closest(".field");
      }

      function px(n) { return `${Math.round(n)}px`; }

      function getTopLeft(field) {
        const t = parseFloat(field.style.top);
        const l = parseFloat(field.style.left);
        return {
          top: Number.isNaN(t) ? field.offsetTop : t,
          left: Number.isNaN(l) ? field.offsetLeft : l
        };
      }

      // Prevent text selection while dragging
      function setNoSelect(on) {
        document.body.style.userSelect = on ? "none" : "";
      }

      wrapper.addEventListener("mousedown", (e) => {
        // only left click
        if (e.button !== 0) return;

        const field = getFieldTarget(e.target);
        if (!field) return;

        // Don’t drag track checkboxes (they’re inside containers)
        // You CAN drag them if you want, but it’s messy since their container controls placement.
        const key = field.dataset.key || "";
        if (/_\d+$/.test(key)) return;

        e.preventDefault();

        dragging = field;
        dragging.classList.remove("parked");

        const cur = getTopLeft(dragging);
        startPos = { top: cur.top, left: cur.left };
        startMouse = { x: e.clientX, y: e.clientY };

        setNoSelect(true);
        readout.textContent = `${key} → top:${Math.round(cur.top)} left:${Math.round(cur.left)}`;
      });

      window.addEventListener("mousemove", (e) => {
        if (!dragging) return;

        const dx = e.clientX - startMouse.x;
        const dy = e.clientY - startMouse.y;

        let newTop = startPos.top + dy;
        let newLeft = startPos.left + dx;

        // Shift = snap to 10px grid
        if (e.shiftKey) {
          newTop = Math.round(newTop / 10) * 10;
          newLeft = Math.round(newLeft / 10) * 10;
        } else {
          newTop = Math.round(newTop);
          newLeft = Math.round(newLeft);
        }

        dragging.style.top = px(newTop);
        dragging.style.left = px(newLeft);

        const key = dragging.dataset.key || "";
        readout.textContent = `${key} → top:${newTop} left:${newLeft}`;
      });

      window.addEventListener("mouseup", () => {
        if (!dragging) return;
        setNoSelect(false);

        const key = dragging.dataset.key || "";
        console.log(`[layout] ${key}: top:${dragging.style.top} left:${dragging.style.left}`);

        dragging = null;
      });

      // Optional: nudge selected field with arrow keys
      let selected = null;
      wrapper.addEventListener("click", (e) => {
        const field = getFieldTarget(e.target);
        if (!field) return;
        selected = field;
      });

      window.addEventListener("keydown", (e) => {
        if (!selected) return;
        if (!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) return;

        // Don’t move when typing in inputs
        const tag = (document.activeElement && document.activeElement.tagName) || "";
        if (tag === "INPUT" || tag === "TEXTAREA") return;

        e.preventDefault();

        const step = e.shiftKey ? 10 : 1;
        const cur = getTopLeft(selected);

        let top = cur.top;
        let left = cur.left;

        if (e.key === "ArrowUp") top -= step;
        if (e.key === "ArrowDown") top += step;
        if (e.key === "ArrowLeft") left -= step;
        if (e.key === "ArrowRight") left += step;

        selected.style.top = px(top);
        selected.style.left = px(left);

        const key = selected.dataset.key || "";
        readout.textContent = `${key} → top:${top} left:${left}`;
      });
    })();
  </script>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script src="firebase-config.js"></script>
  <script src="sheet-firebase.js"></script>
</body>
</html>
